package IT.Java;

import java.util.concurrent.CompletableFuture;

/**
 * Learn Java from https://www.liaoxuefeng.com/
 * 
 * @author liaoxuefeng
 */
public class Main {
	public static void main(String[] args) throws Exception {
		// ä¸¤ä¸ªCompletableFutureæ‰§è¡Œå¼‚æ­¥æŸ¥è¯¢:
		CompletableFuture<String> cfQueryFromSina = CompletableFuture.supplyAsync(() -> {
			return queryCode("ä¸­å›½çŸ³æ²¹", "https://finance.sina.com.cn/code/");
		});
		CompletableFuture<String> cfQueryFrom163 = CompletableFuture.supplyAsync(() -> {
			return queryCode("ä¸­å›½çŸ³æ²¹", "https://money.163.com/code/");
		});

		// ç”¨anyOfå?ˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„CompletableFuture:
		CompletableFuture<Object> cfQuery = CompletableFuture.anyOf(cfQueryFromSina, cfQueryFrom163);

		// ä¸¤ä¸ªCompletableFutureæ‰§è¡Œå¼‚æ­¥æŸ¥è¯¢:
		CompletableFuture<Double> cfFetchFromSina = cfQuery.thenApplyAsync((code) -> {
			return fetchPrice((String) code, "https://finance.sina.com.cn/price/");
		});
		CompletableFuture<Double> cfFetchFrom163 = cfQuery.thenApplyAsync((code) -> {
			return fetchPrice((String) code, "https://money.163.com/price/");
		});

		// ç”¨anyOfå?ˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„CompletableFuture:
		CompletableFuture<Object> cfFetch = CompletableFuture.anyOf(cfFetchFromSina, cfFetchFrom163);

		// æœ€ç»ˆç»“æžœ:
		cfFetch.thenAccept((result) -> {
			System.out.println("price: " + result);
		});
		// ä¸»çº¿ç¨‹ä¸?è¦?ç«‹åˆ»ç»“æ?Ÿï¼Œå?¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
		Thread.sleep(2000);
	}

	static String queryCode(String name, String url) {
		System.out.println("query code from " + url + "...");
		try {
			Thread.sleep((long) Math.random() * 1000);
		} catch (InterruptedException e) {
		}
		return "601857";
	}

	static Double fetchPrice(String code, String url) {
		System.out.println("query price from " + url + "...");
		try {
			Thread.sleep((long) Math.random() * 1000);
		} catch (InterruptedException e) {
		}
		return 5 + Math.random() * 20;
	}
}
